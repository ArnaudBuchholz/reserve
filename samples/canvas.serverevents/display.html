<html>
  <head>
    <title>Display</title>
    <script>
      const count = parseInt((location.search.match(/count=(\d+)/) || [,4])[1])
      const header = parseInt((location.search.match(/header=(\d+)/) || [,0])[1])
      const shared = !!location.search.match(/shared=true/)
      const cols = Math.ceil(Math.sqrt(count))
      const rows = Math.ceil(count / cols)
      const features = {
        height: Math.floor(screen.height / rows) - header,
        location: 0,
        menubar: 0,
        resizable: 0,
        status: 0,
        toolbar: 0,
        width: Math.floor(screen.width / cols)
      }
      const windows = []
      let index = 0
      if (shared) {
        const plotsSource = new EventSource('/plots')
        plotsSource.addEventListener('plot', e => {
          const { data, lastEventId } = e
          localStorage[`plot#${lastEventId}`] = data
          localStorage[`plot.lastEventId`] = lastEventId
        })
      }
      while (index < count) {
        const windowFeatures = Object.keys(features)
          .map(name => name + '=' + features[name].toString())
          .concat('left=' + (index % cols) * features.width)
          .concat('top=' + Math.floor(index / cols) * (features.height + header))
          .join(',')
          windows.push(window.open(`http://localhost:8082/draw.html?shared=${shared}`, '_blank', windowFeatures))
        ++index
      }
    </script>
  </head>
  <body>
      <button>close</button>
      <script>
        document.querySelector('button').addEventListener('click', () => windows.forEach(wnd => wnd.close()))
      </script>
  </body>
</html>