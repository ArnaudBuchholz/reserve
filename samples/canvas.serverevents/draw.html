<!doctype html>
<html>
  <head>
    <title>Draw !</title>
    <style>
html, body {
  width:  100%;
  height: 100%;
  margin: 0;
}    
    </style>
  </head>
  <body>
    <canvas></canvas>
  </body>
  <script>
    const canvas = document.querySelector('canvas')
    const context = canvas.getContext("2d")
    function resize () {
      canvas.width = window.innerWidth
      canvas.height = window.innerHeight
    }
    window.addEventListener('resize', resize)
    resize()
    let draw = false
    canvas.addEventListener('mousemove', event => {
      const { clientX, clientY } = event
      const body = [clientX, clientY].join(',')
      if (draw) {
        fetch('/plots', {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
            'Content-Length': body.length
          },
          body
        })
      }
    })
    canvas.addEventListener('mousedown', event => {
      draw = true
    })
    canvas.addEventListener('mouseup', event => {
      draw = false
    })
    function plot(coords) {
      const [rawX, rawY] = coords.split(',')
      const x = parseInt(rawX, 10)
      const y = parseInt(rawY, 10)
      context.beginPath()
      context.arc(x, y, 10, 0, 2 * Math.PI)
      context.stroke()
    }
    const shared = !!location.search.match(/shared=true/)
    if (shared) {
      window.addEventListener('storage', event => {
        if (event.key === 'plot') {
          plot(event.newValue)
        }
      })
    } else {
      const plotsSource = new EventSource('/plots')
      plotsSource.addEventListener('plot', e => {
        plot(e.data)
      })
    }
  </script>
</html>